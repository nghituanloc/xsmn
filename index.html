<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5"/>
<title>KQXS Miền Nam</title>
<link rel="manifest" href="manifest.webmanifest">
<link rel="apple-touch-icon" href="icons/icon-180.png">
<meta name="theme-color" content="#b71c1c">

<meta name="referrer" content="no-referrer">
<meta http-equiv="Content-Security-Policy" content="default-src * 'unsafe-inline' 'unsafe-eval' data: blob:;">

<script src="https://code.jquery.com/jquery-3.7.1.min.js" crossorigin="anonymous"></script>

<style>
  :root{
    --bg:#f3f4f6; 
    --panel:#ffffff; 
    --text:#111827;
    --red:#d32f2f; 
    --blue:#1565c0;
    --btn-border:#9ca3af;
    --sticky-bg: #fff0f0;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family: Helvetica, Arial, sans-serif;
    background:var(--bg);
    color:var(--text);
    padding-bottom: 20px; /* Chừa chỗ cho footer */
    overflow-y: auto; 
  }
  .wrap{max-width:1400px;margin:0 auto;padding:10px; min-height: 90vh; display: flex; flex-direction: column;}

  .noscript-banner{
    background:#fff3cd;
    color:#92400e;
    border:1px solid #fbbf24;
    border-radius:10px;
    padding:12px 14px;
    margin:10px auto 20px;
    max-width:1100px;
    font-weight:700;
    text-align:center;
    box-shadow:0 2px 4px rgba(0,0,0,0.08);
  }

  /* --- CONTROL AREA --- */
  .control-area {
    background: #fff;
    padding: 15px 10px;
    border-radius: 15px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    margin-bottom: 20px;
    text-align: center;
  }

  /* NAV BAR */
  .nav-bar {
    display: flex;
    justify-content: center;
    align-items: stretch;
    gap: 10px;
    max-width: 600px;
    margin: 0 auto;
  }
  .btn-arrow {
    background: white;
    border: 2px solid var(--btn-border);
    border-radius: 10px;
    width: 60px;
    font-size: 28px;
    font-weight: 700;
    color: #374151;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    flex: none;
    touch-action: manipulation;
  }
  .btn-arrow:active { background: #e5e7eb; transform: scale(0.95); }
  .btn-arrow:disabled{
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
    background: #f9fafb;
  }

  input[type="date"] {
    appearance: none;
    -webkit-appearance: none;
    flex: 1;
    height: 60px;
    font-size: 22px; 
    font-weight: 700;
    text-align: center;
    text-align-last: center;
    color: #111;
    padding: 0 10px;
    background-color: #fff;
    border: 2px solid var(--blue);
    border-radius: 10px;
    box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
  }

  /* --- BẢNG KẾT QUẢ --- */
  .panel{
    background:var(--panel);
    border-radius:12px;
    overflow:hidden;
    box-shadow:0 2px 10px rgba(0,0,0,0.1);
    border: 1px solid #ddd;
    margin-bottom: 30px;
    flex: 1; /* Đẩy footer xuống đáy */
  }
  .panel + .panel{
    margin-top:10px;
  }
  .caption{
    background:var(--red);
    color:#fff;
    padding:15px;
    text-align: center;
    font-weight: 800;
    font-size: 20px;
    text-transform: uppercase;
  }

  .tableWrap{
    width: 100%;
    overflow-x: auto; 
    overflow-y: hidden;
    max-height: none; 
    position: relative;
    -webkit-overflow-scrolling: touch;
    touch-action: pan-x pan-y; 
  }
  
  .tbl{ width:100%; border-collapse: separate; border-spacing: 0; }
  .tbl th, .tbl td{ 
    border-right: 1px solid #cbd5e1; 
    border-bottom: 1px solid #cbd5e1; 
    padding: 15px 5px; 
    text-align:center; 
    vertical-align:middle; 
  }

  /* Sticky Styles */
  .tbl .prize, .tbl thead th:first-child { 
    width: 90px; min-width: 90px; white-space: nowrap; 
    position: sticky; left: 0; 
    background: var(--sticky-bg); 
    border-right: 3px solid hsl(0, 96%, 64%); 
    text-align: center; padding: 12px 6px; font-weight: 800;
    z-index: 40;
  }
  .tbl thead th.province {
    font-size: 22px; font-weight: 900; background: #ffffff; padding: 20px 5px;
    border-bottom: 2px solid #b71c1c; min-width: 140px;
    position: sticky; top: 0; z-index: 50; 
  }
  .tbl thead th:first-child {
    top: 0; z-index: 60; background: #fff0f0; border-bottom: 2px solid #b71c1c; font-size: 17px; color: #333;
  }

  /* Text Sizes */
  .tbl tbody td:not(.prize) { font-size: 50px !important; font-weight: 900; letter-spacing: 2px; line-height: 1.2; min-width: 150px; }
  .tbl .g8 { color: var(--red); font-size: 55px !important; }
  .tbl .db { color: #d50000; font-size: 55px !important; }
  
  #scratch{display:none}

  /* --- FOOTER & INSTALL BUTTON --- */
  .main-footer {
    text-align: center;
    padding: 20px 10px;
    color: #6b7280;
    font-size: 14px;
    margin-top: auto;
  }
  .copyright b { color: #333; }
  
  .btn-install {
    display: none; /* Mặc định ẩn, hiện khi trình duyệt cho phép */
    background-color: #16a34a; /* Màu xanh lá dễ chịu */
    color: white;
    font-size: 18px;
    font-weight: bold;
    padding: 12px 25px;
    border: none;
    border-radius: 50px;
    margin-bottom: 15px;
    cursor: pointer;
    box-shadow: 0 4px 6px rgba(0,0,0,0.2);
    animation: pulse 2s infinite;
  }
  @keyframes pulse {
    0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(22, 163, 74, 0.7); }
    70% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(22, 163, 74, 0); }
    100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(22, 163, 74, 0); }
  }

  .scroll-top{
    position: fixed;
    right: 16px;
    bottom: 80px;
    background: #255cb4;
    color: #fff;
    border: none;
    border-radius: 5px;
    padding: 10px 14px;
    font-weight: 700;
    cursor: pointer;
    box-shadow: 0 6px 12px rgba(0,0,0,0.2);
    display: none;
    z-index: 120;
  }
  .scroll-top:active{ transform: translateY(1px); }

  @media (max-width: 768px) {
    .wrap { padding: 5px; }
    input[type="date"] { font-size: 20px; }
    .btn-arrow { width: 50px; font-size: 24px; }
    .tbl thead th.province { font-size: 18px; padding: 15px 5px; min-width: 110px; } 
    .tbl tbody td:not(.prize) { font-size: 40px !important; letter-spacing: 1px; min-width: 110px; }
    .tbl .g8 { font-size: 45px !important; }
    .tbl .db { font-size: 44px !important; }
    .tbl .prize, .tbl thead th:first-child { font-size: 15px; padding: 8px 4px; width: 70px; min-width: 70px; }
  }
</style>
</head>
<body>

<noscript>
  <div class="noscript-banner">
    Thiết bị đang chặn JavaScript nên không thể tải kết quả. Vui lòng bật JavaScript hoặc tắt chặn script, rồi tải lại trang.
  </div>
</noscript>

<div class="wrap">
  <div class="control-area">
    <div class="nav-bar">
      <button class="btn-arrow" onclick="changeDate(-1)">&#10094;</button>
      <input id="date" type="date" onchange="handleDateChange()" />
      <button id="btnNext" class="btn-arrow" onclick="changeDate(1)">&#10095;</button>
    </div>
  </div>

  <div id="panels"></div>

  <footer class="main-footer">
    <button id="btnInstall" class="btn-install">CÀI ỨNG DỤNG</button>
    <div class="copyright">
      Phát triển bởi <b>Loc</b> &copy; 2025
    </div>
  </footer>

  <div id="scratch"></div>
</div>

<button id="btnTop" class="scroll-top" aria-label="Lên đầu trang">^</button>

<script>
// --- LOGIC CÀI APP (PWA) ---
let deferredPrompt;
const btnInstall = document.getElementById('btnInstall');
const btnTop = document.getElementById('btnTop');
const btnNext = document.getElementById('btnNext');
let appInstalled = false;

window.addEventListener('beforeinstallprompt', (e) => {
  // Ngăn Chrome hiển thị popup mặc định
  e.preventDefault();
  // Lưu sự kiện để dùng sau
  deferredPrompt = e;
  // Hiện nút cài đặt của mình
  btnInstall.style.display = 'inline-block';
  refreshNavInstallButton();
});

btnInstall.addEventListener('click', async () => {
  if (deferredPrompt) {
    deferredPrompt.prompt();
    const { outcome } = await deferredPrompt.userChoice;
    console.log(`User response to the install prompt: ${outcome}`);
    deferredPrompt = null;
    btnInstall.style.display = 'none'; // Ẩn nút sau khi bấm
    refreshNavInstallButton();
  }
});

window.addEventListener('appinstalled', () => {
  appInstalled = true;
  deferredPrompt = null;
  btnInstall.style.display = 'none';
  refreshNavInstallButton();
});

// --- LOGIC XỔ SỐ (GIỮ NGUYÊN) ---
const DAY_MAP = {
  mon:[{n:'TP. HCM',s:'tp-hcm'},{n:'Đồng Tháp',s:'dong-thap'},{n:'Cà Mau',s:'ca-mau'}],
  tue:[{n:'Bến Tre',s:'ben-tre'},{n:'Vũng Tàu',s:'vung-tau'},{n:'Bạc Liêu',s:'bac-lieu'}],
  wed:[{n:'Đồng Nai',s:'dong-nai'},{n:'Cần Thơ',s:'can-tho'},{n:'Sóc Trăng',s:'soc-trang'}],
  thu:[{n:'Tây Ninh',s:'tay-ninh'},{n:'An Giang',s:'an-giang'},{n:'Bình Thuận',s:'binh-thuan'}],
  fri:[{n:'Vĩnh Long',s:'vinh-long'},{n:'Bình Dương',s:'binh-duong'},{n:'Trà Vinh',s:'tra-vinh'}],
  sat:[{n:'TP. HCM',s:'tp-hcm'},{n:'Long An',s:'long-an'},{n:'Bình Phước',s:'binh-phuoc'},{n:'Hậu Giang',s:'hau-giang'}],
  sun:[{n:'Tiền Giang',s:'tien-giang'},{n:'Kiên Giang',s:'kien-giang'},{n:'Đà Lạt',s:'da-lat'}]
};
const JS_DAY_KEY = ['sun','mon','tue','wed','thu','fri','sat'];
const DAY_NAMES_VI = ['CHỦ NHẬT', 'THỨ 2', 'THỨ 3', 'THỨ 4', 'THỨ 5', 'THỨ 6', 'THỨ 7'];

const REFRESH_START_MIN = 16*60 + 15; 
const RESULT_FINAL_MIN = 16*60 + 45;

function vnNow(){ return new Date(new Date().toLocaleString('en-US',{timeZone:'Asia/Ho_Chi_Minh'})); }
function pad(n){return n<10?('0'+n):n}
function toDMY(d){return `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()}`}
function toISO(d){return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`}
function parseISOToDate(iso){ const [y,m,d] = iso.split('-').map(Number); return new Date(y, (m||1)-1, d||1); }
function isoToDmyDash(iso){ if(!iso) return ''; const [y,m,d] = iso.split('-'); return `${d}-${m}-${y}`; }
function isTodayBeforeCutoff(dateObj){
  const now = vnNow();
  const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
  const selectedStart = new Date(dateObj.getFullYear(), dateObj.getMonth(), dateObj.getDate());
  const currentMinutes = now.getHours()*60 + now.getMinutes();
  return selectedStart.getTime() === todayStart.getTime() && currentMinutes < REFRESH_START_MIN;
}

let baseDate = vnNow();
const now = vnNow();
const currentMinutes = now.getHours()*60 + now.getMinutes();
// Chỉ set về hôm qua nếu chưa tới 16h15, nhưng nếu đã qua 16h15 thì giữ hôm nay
if(currentMinutes < REFRESH_START_MIN){
  baseDate.setDate(baseDate.getDate()-1);
}
let currentDay = JS_DAY_KEY[baseDate.getDay()];

let loadedDates = new Set();
let nextDate = null;
let isLoadingMore = false;
let scrollAttached = false;
let hideTopTimer = null;
let lastScrollY = 0;
let realtimeCounter = 0;
let realtimeTimer = null;

window.addEventListener('load', () => { registerServiceWorker(); detectInstalledMode(); setupVisibilityRefresh(); resetAndLoad(baseDate); manageAutoRefresh(); setupInfiniteScroll(); });

let lastVisibilityRefresh = 0;
const VISIBILITY_REFRESH_GAP = 30000; // 30s giữa các lần refresh nền

function registerServiceWorker(){
  if(!('serviceWorker' in navigator)) return;
  navigator.serviceWorker.register('service-worker.js')
    .then(() => {
      navigator.serviceWorker.addEventListener('controllerchange', () => {
        window.location.reload();
      });
    })
    .catch(()=>{});
}

function detectInstalledMode(){
  const standalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
  if(standalone){ appInstalled = true; }
}

function updateUI(dateObj) {
  const iso = toISO(dateObj);
  document.getElementById('date').value = iso;
  currentDay = JS_DAY_KEY[dateObj.getDay()];
  refreshNavInstallButton();
}

function isNextBlocked(){
  if(!btnNext) return false;
  const input = document.getElementById('date');
  if(!input || !input.value) return false;
  const current = vnNow();
  const todayStart = new Date(current.getFullYear(), current.getMonth(), current.getDate());
  const viewing = parseISOToDate(input.value);
  const target = new Date(viewing);
  target.setDate(target.getDate()+1);
  const targetStart = new Date(target.getFullYear(), target.getMonth(), target.getDate());
  const currentMinutes = current.getHours()*60 + current.getMinutes();

  if(targetStart.getTime() > todayStart.getTime()) return true; // Ngày tương lai
  if(targetStart.getTime() === todayStart.getTime() && currentMinutes < REFRESH_START_MIN) return true; // Hôm nay nhưng chưa tới giờ quay
  return false;
}

function checkFutureAndAlert(selectedDate) {
  const current = vnNow();
  const todayStart = new Date(current.getFullYear(), current.getMonth(), current.getDate());
  const selectedStart = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), selectedDate.getDate());
  const currentMinutes = current.getHours() * 60 + current.getMinutes();

  if (selectedStart > todayStart) {
    const diffTime = selectedStart - todayStart;
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    alert(`Chưa có kết quả ngày ${toDMY(selectedDate)}, vui lòng đợi ${diffDays} ngày nữa nhé!`);
    return true; 
  }
  return false; 
}

function normalizeBeforeDraw(dateObj){
  if (isTodayBeforeCutoff(dateObj)) {
    // Trước giờ quay: luôn hiển thị kết quả của ngày hôm qua và không gọi API của hôm nay
    const yesterday = new Date(dateObj);
    yesterday.setDate(yesterday.getDate()-1);
    return { normalized: yesterday, redirected: true };
  }
  return { normalized: dateObj, redirected: false };
}

function changeDate(offset) {
  const input = document.getElementById('date');
  const d = parseISOToDate(input.value);
  d.setDate(d.getDate() + offset);
  if(checkFutureAndAlert(d)) return;
  const { normalized } = normalizeBeforeDraw(d);
  resetAndLoad(normalized);
  manageAutoRefresh();
}

function handleDateChange() {
  const input = document.getElementById('date');
  if(!input.value) return;
  const d = parseISOToDate(input.value);
  if(checkFutureAndAlert(d)) {
    // Giữ nguyên ngày đang xem (baseDate), tránh nhảy sang hôm nay khi chưa có kết quả
    updateUI(baseDate);
    return;
  }
  const { normalized } = normalizeBeforeDraw(d);
  resetAndLoad(normalized);
  manageAutoRefresh();
}

async function resetAndLoad(dateObj){
  const panels = document.getElementById('panels');
  panels.innerHTML = '';
  loadedDates = new Set();
  const normalized = new Date(dateObj);
  baseDate = normalized;
  updateUI(baseDate);
  
  // Kiểm tra xem có đang trong khung giờ trực tiếp không
  const n = vnNow();
  const m = n.getHours()*60 + n.getMinutes();
  const today = new Date(n.getFullYear(), n.getMonth(), n.getDate());
  const todayStart = new Date(today.getFullYear(), today.getMonth(), today.getDate());
  const viewingStart = new Date(normalized.getFullYear(), normalized.getMonth(), normalized.getDate());
  const isInRealtimeWindow = viewingStart.getTime() === todayStart.getTime() && m >= REFRESH_START_MIN && m < RESULT_FINAL_MIN;
  
  await appendDay(baseDate, isInRealtimeWindow);
  nextDate = new Date(baseDate);
  nextDate.setDate(nextDate.getDate()-1);
}

function loadProvince(slug, dmyDash){
  return new Promise(resolve=>{
    const scratch = document.getElementById('scratch');
    scratch.id = 'box_kqxs_minhngoc';
    const s = document.createElement('script');
    s.src = dmyDash ? `https://www.minhngoc.com.vn/getkqxs/${slug}/${dmyDash}.js` : `https://www.minhngoc.com.vn/getkqxs/${slug}.js`;
    s.onerror = ()=>{ document.getElementById('box_kqxs_minhngoc').id = 'scratch'; resolve(null); };
    s.onload = ()=>{
      const holder = document.getElementById('box_kqxs_minhngoc');
      holder.id = 'scratch';
      const $box = $('#scratch').find('.box_kqxs_mini').last();
      if($box.length===0){ resolve(null); return; }
      const title = $box.find('.title').text().trim();
      const m = title.match(/KQXS\s+(.+?)\s+(\d{2}\/\d{2}\/\d{4})/i);
      const province = m ? m[1] : slug;
      const dateText = m ? m[2] : '';
      function pick(sel){ return ($box.find(sel).first().text()||'').replace(/\s+/g,' ').trim(); }
      function prettify(s){ return s ? s.split('-').map(x=>x.trim()).join('<br>') : ''; }
      resolve({
        province, date: dateText,
        g8: prettify(pick('.giai8')), g7: prettify(pick('.giai7')), g6: prettify(pick('.giai6')),
        g5: prettify(pick('.giai5')), g4: prettify(pick('.giai4')), g3: prettify(pick('.giai3')),
        g2: prettify(pick('.giai2')), g1: prettify(pick('.giai1')), db: prettify(pick('.giaidb'))
      });
    };
    document.body.appendChild(s);
  });
}

async function fetchDayData(dateObj){
  const iso = toISO(dateObj);
  const dash = isoToDmyDash(iso);
  const dayKey = JS_DAY_KEY[dateObj.getDay()];
  const list = DAY_MAP[dayKey] || [];
  $('#scratch').empty();
  const results = [];
  for (const p of list){
    const data = await loadProvince(p.s, dash);
    if(data) results.push(data);
  }
  const dayName = DAY_NAMES_VI[JS_DAY_KEY.indexOf(dayKey)];
  const shownDate = (iso && toDMY(parseISOToDate(iso))) || '';
  return {iso, dayName, shownDate, results};
}

function buildTable(dayName, cols, forRealtime = false){
  const prizes = [
    {k:'g8',n:'Giải 8',cls:'g8'},{k:'g7',n:'Giải 7'},{k:'g6',n:'Giải 6'},
    {k:'g5',n:'Giải 5'},{k:'g4',n:'Giải 4'},{k:'g3',n:'Giải 3'},
    {k:'g2',n:'Giải Nhì'},{k:'g1',n:'Giải Nhất'},{k:'db',n:'ĐẶC BIỆT',cls:'db'}
  ];
  if(!cols || cols.length===0){
    if(forRealtime){
      // Tạo bảng trống với cấu trúc đúng để realtime có thể cập nhật
      const dayKey = JS_DAY_KEY[baseDate.getDay()];
      const provinceList = DAY_MAP[dayKey] || [];
      if(provinceList.length === 0){
        return '<tbody><tr><td style="padding:24px; font-size:16px; line-height:1.5;">Chưa có dữ liệu, vui lòng thử lại sau.</td></tr></tbody>';
      }
      const thead = `
        <thead>
          <tr>
            <th class="province">${dayName}</th>
            ${provinceList.map(p=>`<th class="province">${p.n}</th>`).join('')}
          </tr>
        </thead>`;
      const tbody = `<tbody>${prizes.map(p=>`<tr><td class="prize">${p.n}</td>${provinceList.map(()=>`<td class="${p.cls||''}"></td>`).join('')}</tr>`).join('')}</tbody>`;
      return thead + tbody;
    }
    return '<tbody><tr><td style="padding:24px; font-size:16px; line-height:1.5;">Chưa có dữ liệu, vui lòng thử lại sau.</td></tr></tbody>';
  }
  const thead = `
    <thead>
      <tr>
        <th class="province">${dayName}</th>
        ${cols.map(c=>`<th class="province">${c.province}</th>`).join('')}
      </tr>
    </thead>`;
  const tbody = `<tbody>${prizes.map(p=>`<tr><td class="prize">${p.n}</td>${cols.map(c=>`<td class="${p.cls||''}">${c[p.k]||''}</td>`).join('')}</tr>`).join('')}</tbody>`;
  return thead + tbody;
}

function renderPanel({iso, dayName, shownDate, tableHtml}){
  return `
    <div class="panel" data-iso="${iso}">
      <div class="caption">${dayName} - ${shownDate}</div>
      <div class="tableWrap">
        <table class="tbl">${tableHtml}</table>
      </div>
    </div>
  `;
}

async function appendDay(dateObj, forRealtime = false){
  if(isTodayBeforeCutoff(dateObj)){
    const yesterday = new Date(dateObj);
    yesterday.setDate(yesterday.getDate()-1);
    return appendDay(yesterday, forRealtime);
  }
  const iso = toISO(dateObj);
  if(loadedDates.has(iso) && !forRealtime) return;
  
  // Nếu đang trong khung giờ trực tiếp, chỉ tạo panel trống, không load dữ liệu từ API thông thường
  if(forRealtime){
    if(!loadedDates.has(iso)){
      const dayKey = JS_DAY_KEY[dateObj.getDay()];
      const dayName = DAY_NAMES_VI[JS_DAY_KEY.indexOf(dayKey)];
      const shownDate = toDMY(dateObj);
      const tableHtml = buildTable(dayName, [], true);
      const panelHtml = renderPanel({iso: iso, dayName: dayName, shownDate: shownDate, tableHtml});
      document.getElementById('panels').insertAdjacentHTML('beforeend', panelHtml);
      loadedDates.add(iso);
    }
    // Không gọi fetchDayData() khi forRealtime = true, để realtime API tự cập nhật
    return;
  }
  
  // Trường hợp bình thường: load dữ liệu từ API
  loadedDates.add(iso);
  const data = await fetchDayData(dateObj);
  const tableHtml = buildTable(data.dayName, data.results, false);
  const panelHtml = renderPanel({iso: data.iso, dayName: data.dayName, shownDate: data.shownDate, tableHtml});
  document.getElementById('panels').insertAdjacentHTML('beforeend', panelHtml);
}

async function reloadDay(dateObj){
  const iso = toISO(dateObj);
  const panel = document.querySelector(`.panel[data-iso="${iso}"]`);
  if(!panel){
    await appendDay(dateObj);
    return;
  }
  const data = await fetchDayData(dateObj);
  panel.querySelector('.caption').textContent = `${data.dayName} - ${data.shownDate}`;
  panel.querySelector('.tableWrap').innerHTML = `<table class="tbl">${buildTable(data.dayName, data.results)}</table>`;
}

function setupInfiniteScroll(){
  if(scrollAttached) return;
  scrollAttached = true;
  let ticking = false;
  window.addEventListener('scroll', () => {
    if(ticking) return;
    ticking = true;
    requestAnimationFrame(() => {
      ticking = false;
      handleScrollWork();
    });
  });
}

btnTop.addEventListener('click', () => {
  window.scrollTo({top:0, behavior:'smooth'});
});

function handleScrollWork(){
  const currentY = window.scrollY;
  const direction = currentY > lastScrollY ? 'down' : 'up';
  loadMoreIfNeeded();
  toggleScrollTop(currentY, direction);
  lastScrollY = currentY;
}

function isViewingToday(){
  const viewingDate = parseISOToDate(document.getElementById('date').value);
  const now = vnNow();
  const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
  const viewStart = new Date(viewingDate.getFullYear(), viewingDate.getMonth(), viewingDate.getDate());
  return viewStart.getTime() === today.getTime();
}

function isViewingYesterday(){
  const viewingDate = parseISOToDate(document.getElementById('date').value);
  const now = vnNow();
  const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
  const yesterday = new Date(today);
  yesterday.setDate(yesterday.getDate()-1);
  const viewStart = new Date(viewingDate.getFullYear(), viewingDate.getMonth(), viewingDate.getDate());
  return viewStart.getTime() === yesterday.getTime();
}

function refreshNavInstallButton(){
  if(!btnNext) return;
  const shouldOfferInstall = !appInstalled && deferredPrompt && (isViewingToday() || isViewingYesterday());
  const nextBlocked = isNextBlocked();

  if(shouldOfferInstall){
    btnNext.textContent = 'Cài app';
    btnNext.disabled = false;
    btnNext.onclick = handleNavInstallClick;
    return;
  }

  btnNext.innerHTML = '&#10095;';
  btnNext.disabled = nextBlocked;
  btnNext.onclick = nextBlocked ? null : () => changeDate(1);
}

async function handleNavInstallClick(){
  if(!deferredPrompt){
    if(btnInstall) btnInstall.click();
    return;
  }
  deferredPrompt.prompt();
  const { outcome } = await deferredPrompt.userChoice;
  if(outcome === 'accepted'){
    appInstalled = true;
    btnInstall.style.display = 'none';
  }
  deferredPrompt = null;
  refreshNavInstallButton();
}

function toggleScrollTop(pos, direction){
  if(!btnTop) return;
  const beyondThreshold = pos > 300;
  if(!beyondThreshold || direction === 'up'){
    hideTopButton();
    return;
  }
  showTopButton();
}

function showTopButton(){
  btnTop.style.display = 'block';
  resetHideTopTimer();
}

function hideTopButton(){
  btnTop.style.display = 'none';
  if(hideTopTimer){
    clearTimeout(hideTopTimer);
    hideTopTimer = null;
  }
}

function resetHideTopTimer(){
  if(hideTopTimer){
    clearTimeout(hideTopTimer);
  }
  hideTopTimer = setTimeout(()=>hideTopButton(), 2000);
}

async function loadMoreIfNeeded(){
  if(isLoadingMore || !nextDate) return;
  const nearBottom = window.innerHeight + window.scrollY >= document.body.offsetHeight - 200;
  if(!nearBottom) return;
  isLoadingMore = true;
  const targetDate = new Date(nextDate);
  nextDate.setDate(nextDate.getDate()-1);
  try{
    await appendDay(targetDate);
  }finally{
    isLoadingMore = false;
  }
}

let refreshTimer = null;
async function manageAutoRefresh(){
  if(refreshTimer) clearInterval(refreshTimer);
  if(realtimeTimer) clearInterval(realtimeTimer);
  
  const n = vnNow();
  const m = n.getHours()*60 + n.getMinutes();
  const viewingDate = parseISOToDate(document.getElementById('date').value);
  const today = new Date(n.getFullYear(), n.getMonth(), n.getDate());
  const todayStart = new Date(today.getFullYear(), today.getMonth(), today.getDate());
  const viewingStart = new Date(viewingDate.getFullYear(), viewingDate.getMonth(), viewingDate.getDate());
  
  // Nếu đang trong khung giờ trực tiếp và đang xem hôm nay
  if(viewingStart.getTime() === todayStart.getTime() && m >= REFRESH_START_MIN && m < RESULT_FINAL_MIN){
    // Đảm bảo baseDate là hôm nay (không phải hôm qua)
    if(baseDate.getTime() !== todayStart.getTime()){
      baseDate = new Date(today);
      updateUI(baseDate);
    }
    
    // Xóa panel cũ nếu có (có thể có dữ liệu cũ) và tạo lại panel trống cho realtime
    const iso = toISO(baseDate);
    const existingPanel = document.querySelector(`.panel[data-iso="${iso}"]`);
    if(existingPanel){
      // Xóa panel cũ để tránh hiển thị dữ liệu cũ
      existingPanel.remove();
      loadedDates.delete(iso);
    }
    
    // Tạo panel mới với cấu trúc trống để realtime cập nhật
    if(!loadedDates.has(iso)){
      await appendDay(baseDate, true); // Tạo panel với cấu trúc trống để realtime cập nhật
    }
    
    // Trong khoảng 16h15 - 16h40, dùng realtime API
    const REALTIME_END = 16*60 + 40;
    if(m < REALTIME_END){
      await startRealtimeUpdates();
    }else{
      // Sau 16h40, dùng reload bình thường
      refreshTimer = setInterval(()=>reloadDay(baseDate), 60000);
    }
  }
}

function setupVisibilityRefresh(){
  document.addEventListener('visibilitychange', () => {
    if(document.visibilityState !== 'visible') return;

    const nowTs = Date.now();
    if(nowTs - lastVisibilityRefresh < VISIBILITY_REFRESH_GAP) return;

    const inStandalone = appInstalled || window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
    if(!inStandalone) return;

    lastVisibilityRefresh = nowTs;
    const viewingDate = parseISOToDate(document.getElementById('date').value);
    reloadDay(viewingDate);
    manageAutoRefresh();
  });
}

async function startRealtimeUpdates(){
  realtimeCounter = 0;
  // Đảm bảo panel đã được tạo trước khi bắt đầu realtime
  const iso = toISO(baseDate);
  if(!loadedDates.has(iso)){
    await appendDay(baseDate, true); // Tạo panel với cấu trúc trống để realtime cập nhật
  }
  // Đợi một chút để DOM được render
  setTimeout(() => {
    loadRealtimeData(); // Gọi ngay lần đầu
  }, 300);
}

async function loadRealtimeData(){
  if(realtimeTimer) clearInterval(realtimeTimer);
  
  realtimeCounter++;
  const url = `https://dc.minhngoc.net/O0O/0/xstt/js_m1.js?_=${realtimeCounter}`;
  
  try{
    // Reset global object
    window.kqxs = undefined;
    
    const script = document.createElement('script');
    script.src = url;
    script.onerror = ()=>{
      // Nếu lỗi, thử lại sau 5 giây
      if(script.parentNode){
        document.body.removeChild(script);
      }
      realtimeTimer = setTimeout(loadRealtimeData, 5000);
    };
    script.onload = ()=>{
      // Kiểm tra dữ liệu với retry mechanism
      let retryCount = 0;
      const maxRetries = 10;
      const checkData = () => {
        if(script.parentNode){
          document.body.removeChild(script);
        }
        
        // Kiểm tra dữ liệu từ window.kqxs
        if(window.kqxs && window.kqxs.mn){
          const data = window.kqxs.mn;
          
          // Kiểm tra xem còn đang trực tiếp không
          if(data.run === 0 || !data.kq){
            // Đã hết trực tiếp, dừng realtime và load kết quả đầy đủ
            if(realtimeTimer) clearTimeout(realtimeTimer);
            realtimeTimer = null;
            reloadDay(baseDate);
            return;
          }
          
          // Còn đang trực tiếp, cập nhật kết quả
          updateRealtimeResults(data);
          // Dùng delay từ API, mặc định 3000ms
          const delay = data.delay || 3000;
          realtimeTimer = setTimeout(loadRealtimeData, delay);
        }else if(retryCount < maxRetries){
          // Nếu chưa có dữ liệu, thử lại sau 100ms
          retryCount++;
          setTimeout(checkData, 100);
        }else{
          // Nếu đã thử nhiều lần mà vẫn không có dữ liệu, thử lại sau 5 giây
          realtimeTimer = setTimeout(loadRealtimeData, 5000);
        }
      };
      
      // Bắt đầu kiểm tra sau 100ms
      setTimeout(checkData, 100);
    };
    document.body.appendChild(script);
  }catch(e){
    // Nếu lỗi, thử lại sau 5 giây
    realtimeTimer = setTimeout(loadRealtimeData, 5000);
  }
}

function updateRealtimeResults(data){
  if(!data || !data.kq) {
    return;
  }
  
  const iso = toISO(baseDate);
  let panel = document.querySelector(`.panel[data-iso="${iso}"]`);
  if(!panel) {
    // Nếu chưa có panel, tạo panel với cấu trúc trống
    const isoToday = toISO(baseDate);
    if(!loadedDates.has(isoToday)){
      appendDay(baseDate, true).then(() => {
        // Sau khi panel được tạo, thử lại ngay
        updateRealtimeResults(data);
      });
    } else {
      // Đợi một chút để panel được tạo, sau đó thử lại
      setTimeout(() => updateRealtimeResults(data), 300);
    }
    return;
  }
  
  // Lấy danh sách tỉnh trong ngày
  const dayKey = JS_DAY_KEY[baseDate.getDay()];
  const provinceList = DAY_MAP[dayKey] || [];
  if(provinceList.length === 0) return;
  
  // Map từ index API sang tên tỉnh
  const tinhArray = data.tinh ? data.tinh.split(',').map(x => x.trim()) : [];
  if(tinhArray.length === 0) return;
  
  // Tìm table trong panel
  const table = panel.querySelector('table.tbl');
  if(!table) return;
  
  const tbody = table.querySelector('tbody');
  if(!tbody) return;
  
  const rows = tbody.querySelectorAll('tr');
  if(rows.length === 0) return;
  
  // Tạo map từ index API sang vị trí trong provinceList
  // Giả định thứ tự trong tinhArray tương ứng với thứ tự trong provinceList
  tinhArray.forEach((tinhIdx, arrayPos)=>{
    const idx = parseInt(tinhIdx);
    if(isNaN(idx) || !data.kq[idx]) return;
    
    const provinceData = data.kq[idx];
    const colIndex = arrayPos; // Cột trong bảng (0,1,2,...) - tương ứng với thứ tự trong provinceList
    
    // Map giải từ API sang row trong bảng
    const prizeMap = [
      {api:'8', row:0, cls:'g8'},
      {api:'7', row:1, cls:''},
      {api:'6', row:2, cls:''},
      {api:'5', row:3, cls:''},
      {api:'4', row:4, cls:''},
      {api:'3', row:5, cls:''},
      {api:'2', row:6, cls:''},
      {api:'1', row:7, cls:''},
      {api:'0', row:8, cls:'db'}
    ];
    
    prizeMap.forEach(prize=>{
      if(rows.length <= prize.row) return;
      
      const row = rows[prize.row];
      if(!row) return;
      
      const cells = row.querySelectorAll('td');
      const cellIndex = colIndex + 1; // +1 vì cột đầu tiên là "prize"
      if(cells.length <= cellIndex) return;
      
      const cell = cells[cellIndex];
      if(!cell) return;
      
      let value = provinceData[prize.api];
      // Cho phép cập nhật cả giá trị rỗng và giá trị có dấu + hoặc *
      if(value === undefined || value === null) return;
      
      // Xử lý dữ liệu
      if(Array.isArray(value)){
        // Giải 6, 4, 3 có nhiều giá trị
        value = value.join('<br>');
      }else if(typeof value === 'string'){
        // Giữ nguyên các dấu + và * để hiển thị trạng thái
        value = value;
      }
      
      // Cập nhật nội dung
      cell.innerHTML = value;
      // Thêm class nếu cần
      if(prize.cls){
        cell.className = prize.cls;
      } else {
        // Xóa class cũ nếu không phải giải đặc biệt
        cell.className = '';
      }
    });
  });
}
</script>
</body>
</html>
